<template>
  <div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b border-gray-200">
      <div class="px-4 py-4">
        <div>
          <div class="grid grid-cols-3 flex items-center justify-center">
            <div>
              <img class="max-w-20" src="/logoType.png" />
            </div>
            <div class="flex items-center justify-center space-x-3">
              <span class="text-xl font-bold text-gray-900">
                å•†å®¶å¾Œå°ç³»çµ±
              </span>
            </div>
            <div class="flex justify-end">
              <button
                @click="logout"
                class="text-red-400 hover:text-gray-600 transition-colors"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="32"
                  height="32"
                  viewBox="0 0 32 32"
                >
                  <path
                    fill="currentColor"
                    d="M16 3C8.832 3 3 8.832 3 16s5.832 13 13 13s13-5.832 13-13S23.168 3 16 3m0 2c6.087 0 11 4.913 11 11s-4.913 11-11 11S5 22.087 5 16S9.913 5 16 5m-.72 4.594L9.595 15.28l-.72.72l.72.72l5.687 5.686L16.72 21l-4-4H23v-2H12.72l4-4z"
                  />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="flex items-center justify-center font-bold mt-5">
      <button
        @click="goToStoreInfo"
        class="flex items-center space-x-2 hover:bg-gray-50 rounded-lg p-1 transition-colors"
      >
        <div
          class="w-8 h-8 bg-pink-500 rounded-full flex items-center justify-center text-white font-semibold text-xl"
        >
          {{ getStoreInitial(merchantInfo.name) }}
        </div>
        <div class="text-pink-600 text-xl ml-1">
          {{ merchantInfo.store_name }}
        </div>
      </button>
    </div>
    <!-- Main Content -->
    <div class="px-4 py-6">
      <!-- è¨‚å–®çµ±è¨ˆå¡ç‰‡ -->
      <div
        class="bg-gradient-to-r from-emerald-500 to-green-600 rounded-xl shadow-lg p-6 mb-6 text-white"
      >
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center space-x-3">
            <div
              class="w-12 h-12 bg-white/20 rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-6 h-6 text-white"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"
                />
              </svg>
            </div>
            <div>
              <h2 class="text-xl font-bold">ç‡Ÿæ¥­æˆæœ</h2>
              <p class="text-emerald-100 text-sm">ç³»çµ±ç‚ºæ‚¨ç´¯ç©çš„æ”¶ç›Š</p>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <!-- æˆåŠŸè¨‚å–®æ•¸ -->
          <div 
            @click="goToLineUsage"
            class="bg-white/10 rounded-lg p-4 backdrop-blur-sm cursor-pointer hover:bg-white/20 transition-colors"
          >
            <div class="flex items-center justify-between mb-2">
              <span class="text-emerald-100 text-sm font-medium">æˆåŠŸæ¥å–®</span>
              <div class="flex items-center space-x-1">
                <svg
                  class="w-4 h-4 text-yellow-300"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                  />
                </svg>
                <svg
                  class="w-5 h-5 text-emerald-200"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M16 11V7a4 4 0 00-8 0v4M8 11v6h8v-6M8 11H6a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2v-6a2 2 0 00-2-2h-2"
                  />
                </svg>
              </div>
            </div>
            <div class="text-3xl font-bold text-white mb-1">
              {{ animatedOrderCount }}
            </div>
            <div class="text-emerald-100 text-xs">ç­†è¨‚å–® (é»æ“ŠæŸ¥çœ‹é‡è¦æé†’)</div>
          </div>

          <!-- ç´¯ç©é‡‘é¡ -->
          <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm">
            <div class="flex items-center justify-between mb-2">
              <span class="text-emerald-100 text-sm font-medium">ç´¯ç©æ”¶ç›Š</span>
              <svg
                class="w-5 h-5 text-emerald-200"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"
                />
              </svg>
            </div>
            <div class="text-3xl font-bold text-white mb-1">
              NT$ {{ animatedRevenue.toLocaleString() }}
            </div>
            <div class="text-emerald-100 text-xs">ç¸½é‡‘é¡</div>
          </div>
        </div>

        <div class="mt-4 pt-4 border-t border-white/20">
          <p class="text-emerald-100 text-sm text-center">
            ğŸ’¡ é€é thankQ ç³»çµ±å¹«æ‚¨è³ºå–çš„æ”¶ç›Š
          </p>
        </div>
      </div>

      <!-- ç‡Ÿæ¥­ç‹€æ…‹å¡ç‰‡ -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6"
      >
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-green-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-semibold text-gray-900">ç‡Ÿæ¥­ç‹€æ…‹</h2>
              <p class="text-sm text-gray-500">æ§åˆ¶åº—å®¶æ˜¯å¦æ¥å—æ–°è¨‚å–®</p>
            </div>
          </div>

          <!-- ç‡Ÿæ¥­ç‹€æ…‹åˆ‡æ› -->
          <div class="space-y-3">
            <div class="flex items-center space-x-3">
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  v-model="isBusinessOpen"
                  @change="toggleBusinessStatus"
                  type="checkbox"
                  class="sr-only peer"
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"
                ></div>
              </label>
              <span
                class="text-sm font-medium min-w-[60px]"
                :class="isBusinessOpen ? 'text-green-600' : 'text-red-600'"
              >
                {{ isBusinessOpen ? 'ç‡Ÿæ¥­ä¸­' : 'å·²é—œé–‰' }}
              </span>
            </div>

            <!-- æ‰‹å‹•æ§åˆ¶ç‹€æ…‹æç¤º -->
            <div
              v-if="merchantInfo.manual_override_until_midnight === 1"
              class="flex items-center space-x-2 text-xs"
            >
              <div class="w-2 h-2 bg-yellow-500 rounded-full"></div>
              <span class="text-yellow-600">æ‰‹å‹•æ§åˆ¶ä¸­ (è‡³ä»Šæ—¥åˆå¤œ)</span>
            </div>
            <div v-else class="flex items-center space-x-2 text-xs">
              <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
              <span class="text-blue-600">è‡ªå‹•æ§åˆ¶ (ä¾ç‡Ÿæ¥­æ™‚é–“)</span>
            </div>
          </div>
        </div>

        <!-- ç•¶ç‡Ÿæ¥­é—œé–‰æ™‚é¡¯ç¤ºçš„è¨‚é¤æœå‹™é–‹é—œ -->
        <div v-if="!isBusinessOpen" class="mt-4 pt-4 border-t border-gray-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div
                class="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center"
              >
                <svg
                  class="w-5 h-5 text-orange-600"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                  />
                </svg>
              </div>
              <div>
                <h3 class="text-lg font-semibold text-gray-900">è¨‚é¤æœå‹™</h3>
                <p class="text-sm text-gray-500">é—œé–‰ç‡Ÿæ¥­æ™‚ä»å¯æ¥å—é è¨‚å–®</p>
              </div>
            </div>

            <div class="flex items-center space-x-3">
              <label class="relative inline-flex items-center cursor-pointer">
                <input
                  v-model="isOrderServiceOpen"
                  @change="toggleOrderService"
                  type="checkbox"
                  class="sr-only peer"
                />
                <div
                  class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-orange-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"
                ></div>
              </label>
              <span
                class="text-sm font-medium min-w-[60px]"
                :class="
                  isOrderServiceOpen ? 'text-orange-600' : 'text-gray-600'
                "
              >
                {{ isOrderServiceOpen ? 'é–‹å•Ÿ' : 'é—œé–‰' }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- åŠŸèƒ½æŒ‰éˆ•å€ -->
      <div class="grid grid-cols-2 gap-4 mb-6">
        <!-- è¨­å®šæŒ‰éˆ• -->
        <button
          @click="goToSettings"
          class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow"
        >
          <div class="text-center">
            <div
              class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-3"
            >
              <svg
                class="w-6 h-6 text-blue-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"
                />
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"
                />
              </svg>
            </div>
            <h3 class="font-medium text-gray-900">é€²éšè¨­å®š</h3>
            <p class="text-sm text-gray-500 mt-1">LINE é »é“é…ç½®</p>
          </div>
        </button>

        <!-- å•†å“ç®¡ç†æŒ‰éˆ• -->
        <button
          @click="goToProducts"
          class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow"
        >
          <div class="text-center">
            <div
              class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-3"
            >
              <svg
                class="w-6 h-6 text-purple-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"
                />
              </svg>
            </div>
            <h3 class="font-medium text-gray-900">å•†å“ç®¡ç†</h3>
            <p class="text-sm text-gray-500 mt-1">æ–°å¢ã€ç·¨è¼¯å•†å“</p>
          </div>
        </button>
      </div>

      <!-- ç‡Ÿæ¥­æ™‚é–“è¨­å®šå€å¡Š -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6"
      >
        <button
          @click="showBusinessHours = !showBusinessHours"
          class="w-full flex items-center justify-between mb-4"
        >
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-indigo-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                />
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-semibold text-gray-900 text-start">
                ç‡Ÿæ¥­æ™‚é–“è¨­å®š
              </h2>
              <p class="text-sm text-gray-500">è¨­å®šæ¯æ—¥ç‡Ÿæ¥­æ™‚é–“èˆ‡ç‰¹æ®Šä¼‘å‡æ—¥</p>
            </div>
          </div>
          <svg
            :class="{'rotate-180': showBusinessHours}"
            class="w-5 h-5 text-gray-400 transition-transform duration-200"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>

        <div v-show="showBusinessHours" class="space-y-6">
          <!-- ç·¨è¼¯æŒ‰éˆ• -->
          <div class="flex justify-end">
            <button
              v-if="!isEditingHours"
              @click="startEditingHours"
              class="flex items-center space-x-2 text-indigo-600 hover:text-indigo-700 text-sm font-medium"
            >
              <svg
                class="w-7 h-7"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                />
              </svg>
            </button>
            <div v-else class="flex items-center space-x-3">
              <button
                @click="cancelEditingHours"
                class="flex items-center space-x-2 text-gray-600 hover:text-gray-700 text-sm font-medium"
              >
                <span>å–æ¶ˆ</span>
              </button>
              <button
                @click="saveBusinessHours"
                class="flex items-center space-x-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
              >
                <span>ä¿å­˜è¨­å®š</span>
              </button>
            </div>
          </div>

          <!-- æ¯é€±ç‡Ÿæ¥­æ™‚é–“ -->
          <div class="space-y-3">
            <h3 class="text-sm font-medium text-gray-900">æ¯é€±ç‡Ÿæ¥­æ™‚é–“</h3>
            <div
              v-for="(day, index) in weekDays"
              :key="index"
              class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0"
            >
              <div class="flex items-center space-x-3 w-20">
                <span class="text-sm font-medium text-gray-700">{{
                  day.name
                }}</span>
              </div>

              <div v-if="!isEditingHours" class="text-right">
                <span class="text-sm text-gray-900">
                  {{ getBusinessHourDisplay(day.value) }}
                </span>
              </div>

              <div v-else class="flex items-center space-x-2">
                <label class="flex items-center">
                  <input
                    v-if="businessHours[day.value]"
                    v-model="businessHours[day.value].is_open"
                    type="checkbox"
                    class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                  />
                  <span class="ml-1 text-xs text-gray-600">ç‡Ÿæ¥­</span>
                </label>

                <template v-if="businessHours[day.value]?.is_open">
                  <input
                    v-if="businessHours[day.value]"
                    v-model="businessHours[day.value].open_time"
                    type="time"
                    class="w-28 px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                  <span class="text-xs text-gray-500">-</span>
                  <input
                    v-if="businessHours[day.value]"
                    v-model="businessHours[day.value].close_time"
                    type="time"
                    class="w-28 px-2 py-1 border border-gray-300 rounded text-xs"
                  />
                </template>
              </div>
            </div>
          </div>

          <!-- ç‰¹æ®Šç‡Ÿæ¥­æ™‚é–“ -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-medium text-gray-900">ä¼‘å‡æ—¥æœŸè¨­å®š</h3>
              <button
                v-if="isEditingHours"
                @click="addSpecialHour"
                class="text-xs text-indigo-600 hover:text-indigo-700 font-medium"
              >
                + æ–°å¢ä¼‘å‡æ—¥æœŸ
              </button>
            </div>

            <div
              v-if="specialHours.length === 0"
              class="text-sm text-gray-500 py-2"
            >
              å°šæœªè¨­å®šä¼‘å‡æ—¥æœŸ
            </div>

            <div
              v-for="(special, index) in specialHours"
              :key="index"
              class="flex items-center justify-between py-2 border-b border-gray-100 last:border-b-0"
            >
              <!-- éç·¨è¼¯æ¨¡å¼ï¼šé¡¯ç¤ºå·²ä¿å­˜çš„ä¼‘å‡æ—¥æœŸ -->
              <div v-if="!isEditingHours" class="flex-1">
                <div class="text-sm font-medium text-gray-700">
                  {{ formatSpecialDate(special.date) }}
                </div>
                <div class="text-xs text-gray-500">
                  {{ special.reason || 'ä¼‘å‡æ—¥' }}
                </div>
              </div>

              <div v-if="!isEditingHours" class="flex items-center space-x-2">
                <span class="text-sm text-gray-900">{{
                  getSpecialHourDisplay(special)
                }}</span>
                <button
                  @click="deleteSpecialHour(special.id, index)"
                  class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50"
                  title="åˆªé™¤ä¼‘å‡æ—¥æœŸ"
                >
                  åˆªé™¤
                </button>
              </div>

              <!-- ç·¨è¼¯æ¨¡å¼ -->
              <div v-else-if="special.id">
                <!-- å·²ä¿å­˜çš„ä¼‘å‡æ—¥æœŸï¼šåªè®€é¡¯ç¤º -->
                <div class="flex items-center justify-between flex-1">
                  <div class="flex-1">
                    <div class="text-sm font-medium text-gray-700">
                      {{ formatSpecialDate(special.date) }}
                    </div>
                    <div class="text-xs text-gray-500">
                      {{ special.reason }}
                    </div>
                  </div>
                  <div class="flex items-center space-x-2">
                    <span class="text-sm text-gray-500">å·²ä¿å­˜</span>
                    <button
                      @click="deleteSpecialHour(special.id, index)"
                      class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50"
                    >
                      åˆªé™¤
                    </button>
                  </div>
                </div>
              </div>

              <div v-else class="flex items-center space-x-2 flex-1">
                <!-- æ–°å¢çš„ä¼‘å‡æ—¥æœŸï¼šå¯ç·¨è¼¯ -->
                <input
                  v-model="special.date"
                  type="date"
                  :min="getTodayDate()"
                  class="w-28 px-2 py-1 border border-gray-300 rounded text-xs"
                />
                <input
                  v-model="special.reason"
                  type="text"
                  placeholder="ä¼‘å‡åŸå›  (å¿…å¡«)"
                  required
                  class="flex-1 px-2 py-1 border border-gray-300 rounded text-xs"
                />

                <button
                  @click="removeSpecialHour(index)"
                  class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded hover:bg-red-50"
                >
                  ç§»é™¤
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- è¨‚é¤è¨­å®šå€å¡Š -->
      <div
        class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-6"
      >
        <button
          @click="showOrderSettings = !showOrderSettings"
          class="w-full flex items-center justify-between mb-4"
        >
          <div class="flex items-center space-x-3">
            <div
              class="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center"
            >
              <svg
                class="w-5 h-5 text-purple-600"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"
                />
              </svg>
            </div>
            <div>
              <h2 class="text-lg font-semibold text-gray-900 text-start">
                è¨‚é¤è¨­å®š
              </h2>
              <p class="text-sm text-gray-500">
                é…ç½®ç”¨é¤æ–¹å¼ã€æ”¯ä»˜é¸é …èˆ‡å„ªæƒ è¨­å®š
              </p>
            </div>
          </div>
          <svg
            :class="{'rotate-180': showOrderSettings}"
            class="w-5 h-5 text-gray-400 transition-transform duration-200"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M19 9l-7 7-7-7"
            />
          </svg>
        </button>

        <div v-show="showOrderSettings" class="space-y-6">
          <!-- ç·¨è¼¯æŒ‰éˆ• -->
          <div class="flex justify-end">
            <button
              v-if="!isEditing"
              @click="startEditing"
              class="flex items-center space-x-2 text-blue-600 hover:text-blue-700 text-sm font-medium"
            >
              <svg
                class="w-7 h-7"
                fill="none"
                stroke="currentColor"
                viewBox="0 0 24 24"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"
                />
              </svg>
            </button>
            <div v-else class="flex items-center space-x-3">
              <button
                @click="cancelEditing"
                class="flex items-center space-x-2 text-gray-600 hover:text-gray-700 text-sm font-medium"
              >
                <span>å–æ¶ˆ</span>
              </button>
              <button
                @click="saveAllSettings"
                class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium"
              >
                <span>ä¿å­˜è¨­å®š</span>
              </button>
            </div>
          </div>

          <!-- è¨­å®šé …ç›®åˆ—è¡¨ -->
          <div class="space-y-4">
            <!-- ç”¨é¤æ–¹å¼ -->
            <div
              class="flex items-center justify-between py-3 border-b border-gray-200"
            >
              <div class="flex items-center space-x-3">
                <span class="w-2 h-2 bg-orange-500 rounded-full"></span>
                <div>
                  <h3 class="font-medium text-gray-900">ç”¨é¤æ–¹å¼</h3>
                  <p class="text-xs text-gray-500">è¨­å®šé¡§å®¢å¯é¸æ“‡çš„ç”¨é¤æ–¹å¼</p>
                </div>
              </div>
              <div class="flex-1 mx-6">
                <div v-if="!isEditing" class="text-right">
                  <span class="text-base font-medium text-gray-900">{{
                    getDiningTypesDisplay()
                  }}</span>
                </div>
                <div v-else class="flex flex-wrap justify-end gap-x-4 gap-y-2">
                  <label class="flex items-center">
                    <input
                      v-model="merchantSettings.available_dining_types"
                      type="checkbox"
                      value="takeaway"
                      class="rounded border-gray-300 text-orange-600 shadow-sm focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50"
                    />
                    <span class="ml-2 text-sm">å¤–å¸¶</span>
                  </label>
                  <label class="flex items-center">
                    <input
                      v-model="merchantSettings.available_dining_types"
                      type="checkbox"
                      value="dine-in"
                      class="rounded border-gray-300 text-orange-600 shadow-sm focus:border-orange-300 focus:ring focus:ring-orange-200 focus:ring-opacity-50"
                    />
                    <span class="ml-2 text-sm">å…§ç”¨</span>
                  </label>
                </div>
              </div>
            </div>

            <!-- æ”¯ä»˜æ–¹å¼ (åªåœ¨æœ‰å¤–é€æœå‹™æ™‚é¡¯ç¤º) -->
            <div
              v-if="
                merchantSettings.available_dining_types.includes('delivery') ||
                !isEditing
              "
              class="flex items-center justify-between py-3 border-b border-gray-200"
            >
              <div class="flex items-center space-x-3">
                <span class="w-2 h-2 bg-indigo-500 rounded-full"></span>
                <div>
                  <h3 class="font-medium text-gray-900">æ”¯ä»˜æ–¹å¼</h3>
                  <p class="text-xs text-gray-500">è¨­å®šé¡§å®¢å¯é¸æ“‡çš„æ”¯ä»˜æ–¹å¼</p>
                </div>
              </div>
              <div class="flex-1 mx-6">
                <div v-if="!isEditing" class="text-right">
                  <span class="text-base font-medium text-gray-900">{{
                    getPaymentMethodsDisplay()
                  }}</span>
                  <!-- éŠ€è¡Œè½‰å¸³è­¦å‘Šæç¤º -->
                  <div v-if="hasBankTransferWithoutAccount" class="mt-1">
                    <span
                      class="text-xs text-red-500 bg-red-50 px-2 py-1 rounded"
                    >
                      âš ï¸ éŠ€è¡Œè½‰å¸³éœ€è¦å…ˆè¨­å®šæ”¶æ¬¾å¸³è™Ÿ
                    </span>
                  </div>
                </div>
                <div v-else class="flex flex-wrap justify-end gap-x-4 gap-y-2">
                  <label class="flex items-center">
                    <input
                      v-model="merchantSettings.available_payment_methods"
                      type="checkbox"
                      value="cash"
                      class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                    />
                    <span class="ml-2 text-sm">ç¾å ´ä»˜æ¬¾</span>
                  </label>
                  <label class="flex items-center">
                    <input
                      v-model="merchantSettings.available_payment_methods"
                      type="checkbox"
                      value="bank_transfer"
                      :class="{
                        'rounded border-red-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50':
                          !isBankTransferAvailable,
                        'rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50':
                          isBankTransferAvailable,
                      }"
                    />
                    <span
                      class="ml-2 text-sm"
                      :class="{'text-red-600': !isBankTransferAvailable}"
                    >
                      éŠ€è¡Œè½‰å¸³
                      <span
                        v-if="!isBankTransferAvailable"
                        class="text-xs text-red-500"
                        >(éœ€è¨­å®šæ”¶æ¬¾å¸³è™Ÿ)</span
                      >
                    </span>
                  </label>
                  <label class="flex items-center">
                    <input
                      v-model="merchantSettings.available_payment_methods"
                      type="checkbox"
                      value="mobile"
                      :disabled="!hasLinePaySettings"
                      class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 disabled:opacity-50 disabled:cursor-not-allowed"
                    />
                    <span class="ml-2 text-sm">
                      è¡Œå‹•æ”¯ä»˜ (LINE Pay)
                      <span
                        v-if="!hasLinePaySettings"
                        class="text-red-500 text-xs block"
                      >
                        éœ€å…ˆè‡³é€²éšè¨­å®šé…ç½® LINE Pay
                      </span>
                    </span>
                  </label>
                </div>
              </div>
            </div>

            <!-- æå‰æŠ˜æ‰£ -->
            <div
              class="flex items-center justify-between py-3 border-b border-gray-200"
            >
              <div class="flex items-center space-x-3">
                <span class="w-2 h-2 bg-yellow-500 rounded-full"></span>
                <div>
                  <h3 class="font-medium text-gray-900">æå‰æŠ˜æ‰£</h3>
                  <p class="text-xs text-gray-500">
                    æå‰ä¸€å¤©è¨‚é¤çµ¦é¡§å®¢çš„å„ªæƒ æŠ˜æ‰£ç‡
                  </p>
                </div>
              </div>
              <div class="flex-1 mx-6">
                <div v-if="!isEditing" class="text-right">
                  <span class="text-base font-medium text-gray-900"
                    >{{ merchantSettings.advance_discount_rate || 0 }}%</span
                  >
                </div>
                <div v-else class="flex items-center justify-end space-x-2">
                  <input
                    v-model.number="merchantSettings.advance_discount_rate"
                    type="number"
                    min="0"
                    max="100"
                    step="0.1"
                    placeholder="0"
                    class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500"
                  />
                  <span class="text-sm text-gray-600">%</span>
                </div>
              </div>
            </div>

            <!-- å¤–é€æœå‹™ -->
            <div class="py-3 border-b border-gray-200">
              <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                  <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                  <div>
                    <h3 class="font-medium text-gray-900">å¤–é€æœå‹™</h3>
                    <p class="text-xs text-gray-500">é–‹å•Ÿå¤–é€æœå‹™åŠç›¸é—œè¨­å®š</p>
                  </div>
                </div>
                <div class="flex-1 mx-6">
                  <div v-if="!isEditing" class="text-right">
                    <span
                      :class="{
                        'text-green-600':
                          merchantSettings.available_dining_types.includes(
                            'delivery'
                          ),
                        'text-gray-600':
                          !merchantSettings.available_dining_types.includes(
                            'delivery'
                          ),
                      }"
                      class="text-base font-medium"
                    >
                      {{
                        merchantSettings.available_dining_types.includes(
                          'delivery'
                        )
                          ? 'é–‹å•Ÿ'
                          : 'é—œé–‰'
                      }}
                    </span>
                  </div>
                  <div v-else class="flex items-center justify-end">
                    <label
                      class="relative inline-flex items-center cursor-pointer"
                    >
                      <input
                        :checked="
                          merchantSettings.available_dining_types.includes(
                            'delivery'
                          )
                        "
                        @change="toggleDeliveryService"
                        type="checkbox"
                        class="sr-only peer"
                      />
                      <div
                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"
                      ></div>
                    </label>
                  </div>
                </div>
              </div>

              <!-- å¤–é€è©³ç´°è¨­å®š (åªåœ¨é–‹å•Ÿå¤–é€ä¸”ç·¨è¼¯æ¨¡å¼æ™‚é¡¯ç¤º) -->
              <div
                v-if="
                  isEditing &&
                  merchantSettings.available_dining_types.includes('delivery')
                "
                class="mt-4 ml-5 space-y-4 pl-4 border-l-2 border-gray-200"
              >
                <!-- å…è²»å¤–é€é‡‘é¡ -->
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900">
                      å…è²»å¤–é€é–€æª»
                    </h4>
                    <p class="text-xs text-gray-500">
                      è¨‚å–®é‡‘é¡é”æ­¤æ•¸é¡äº«å…è²»å¤–é€
                    </p>
                  </div>
                  <div
                    class="flex items-center space-x-2 min-w-[120px] justify-end"
                  >
                    <input
                      v-model.number="merchantSettings.delivery_minimum_amount"
                      type="number"
                      min="0"
                      step="1"
                      placeholder="0"
                      class="w-16 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                    />
                    <span class="text-xs text-gray-600 w-4">å…ƒ</span>
                  </div>
                </div>

                <!-- åŸºæœ¬å¤–é€è²» -->
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900">
                      åŸºæœ¬å¤–é€è²»
                    </h4>
                    <p class="text-xs text-gray-500">åŸºæœ¬è²»ç”¨åŠå…è²»ç¯„åœ</p>
                  </div>
                  <div
                    class="flex items-center space-x-1 min-w-[120px] justify-end"
                  >
                    <input
                      v-model.number="merchantSettings.delivery_base_fee"
                      type="number"
                      min="0"
                      step="1"
                      placeholder="0"
                      class="w-12 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                    />
                    <span class="text-xs text-gray-600">å…ƒ</span>
                    <input
                      v-model.number="merchantSettings.delivery_free_km"
                      type="number"
                      min="0"
                      step="0.1"
                      placeholder="0"
                      class="w-12 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                    />
                    <span class="text-xs text-gray-600">km</span>
                  </div>
                </div>

                <!-- æ¯å…¬é‡Œå¤–é€è²» -->
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900">
                      æ¯å…¬é‡ŒåŠ æ”¶
                    </h4>
                    <p class="text-xs text-gray-500">è¶…å‡ºå…è²»ç¯„åœæ¯å…¬é‡Œè²»ç”¨</p>
                  </div>
                  <div
                    class="flex items-center space-x-2 min-w-[120px] justify-end"
                  >
                    <input
                      v-model.number="merchantSettings.delivery_per_km_fee"
                      type="number"
                      min="0"
                      step="1"
                      placeholder="0"
                      class="w-16 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                    />
                    <span class="text-xs text-gray-600 whitespace-nowrap"
                      >å…ƒ/km</span
                    >
                  </div>
                </div>

                <!-- æœ€å¤§å¤–é€è·é›¢ -->
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900">æœ€å¤§è·é›¢</h4>
                    <p class="text-xs text-gray-500">æœ€å¤§å¤–é€ç¯„åœï¼Œ0ç‚ºç„¡é™åˆ¶</p>
                  </div>
                  <div
                    class="flex items-center space-x-2 min-w-[120px] justify-end"
                  >
                    <input
                      v-model.number="merchantSettings.max_delivery_distance"
                      type="number"
                      min="0"
                      step="0.1"
                      placeholder="0"
                      class="w-16 px-2 py-1 border border-gray-300 rounded text-sm text-right"
                    />
                    <span class="text-xs text-gray-600 w-4">km</span>
                  </div>
                </div>

                <!-- é å…ˆæ”¶æ¬¾ -->
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900">é å…ˆæ”¶æ¬¾</h4>
                    <p class="text-xs text-gray-500">
                      å¼·åˆ¶é æ”¶æ¬¾é …( âŒ ç¾å ´ä»˜æ¬¾ â­•ï¸ LINEPAY â­•ï¸ è½‰å¸³ )
                    </p>
                  </div>
                  <div class="flex items-center min-w-[120px] justify-end">
                    <label class="flex items-center cursor-pointer">
                      <input
                        v-model="merchantSettings.delivery_prepayment"
                        type="checkbox"
                        :true-value="1"
                        :false-value="0"
                        class="rounded border-gray-300 text-purple-600 shadow-sm focus:border-purple-300 focus:ring focus:ring-purple-200 focus:ring-opacity-50"
                      />
                      <span class="ml-2 text-xs text-gray-600">å•Ÿç”¨</span>
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- çµ±è¨ˆè³‡è¨Š -->
      <div
        class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl p-6 text-white"
      >
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg font-semibold">é¡§å®¢é»é¤é€£çµ</h3>
            <p class="text-green-100 text-sm mt-1">åˆ†äº«çµ¦é¡§å®¢é€²è¡Œé»é¤</p>
          </div>
          <button
            @click="copyOrderLink"
            class="bg-white/20 hover:bg-white/30 rounded-lg p-3 transition-colors"
          >
            <svg
              class="w-5 h-5"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"
              />
            </svg>
          </button>
        </div>

        <div class="mt-4 p-3 bg-white/10 rounded-lg">
          <p class="text-sm font-mono break-all">{{ orderLink }}</p>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup>
// æ™‚é–“æ ¼å¼åŒ–å‡½æ•¸ï¼Œç¢ºä¿æ ¼å¼ç‚º HH:MM:SS
const formatTimeForDb = (timeString) => {
  if (!timeString) return null;
  // å¦‚æœå·²ç¶“æ˜¯ HH:MM:SS æ ¼å¼ï¼Œç›´æ¥è¿”å›å‰8å€‹å­—ç¬¦
  if (timeString.length >= 8 && timeString.includes(':')) {
    return timeString.slice(0, 8);
  }
  // å¦‚æœæ˜¯ HH:MM æ ¼å¼ï¼Œæ·»åŠ  :00
  if (timeString.length === 5 && timeString.includes(':')) {
    return timeString + ':00';
  }
  // å…¶ä»–æƒ…æ³ï¼Œå˜—è©¦è§£æä¸¦æ ¼å¼åŒ–
  return timeString.slice(0, 8);
};

const merchantInfo = ref({
  name: '',
  store_name: '',
  phone: '',
  email: '',
  store_description: '',
  lineId: '',
  is_active: 1,
  order_service_active: 0,
});

// è¨‚å–®çµ±è¨ˆç›¸é—œè®Šæ•¸
const orderStats = ref({
  totalOrders: 0,
  totalRevenue: 0,
});

const animatedOrderCount = ref(0);
const animatedRevenue = ref(0);

const merchantSettings = ref({
  available_dining_types: ['takeaway'],
  available_payment_methods: ['cash'],
  advance_discount_rate: 0,
  delivery_minimum_amount: 0,
  delivery_base_fee: 0,
  delivery_free_km: 0,
  delivery_per_km_fee: 0,
  delivery_prepayment: 0,
  max_delivery_distance: 0,
});

const isBusinessOpen = ref(true);
const isOrderServiceOpen = ref(false); // è¨‚é¤æœå‹™é–‹é—œç‹€æ…‹
const showOrderSettings = ref(false);
const isEditing = ref(false); // è¿½è¹¤æ˜¯å¦åœ¨ç·¨è¼¯æ¨¡å¼
const originalSettings = ref({}); // ä¿å­˜åŸå§‹è¨­å®šå€¼ä»¥ä¾›å–æ¶ˆæ™‚é‚„åŸ

// ç‡Ÿæ¥­æ™‚é–“ç›¸é—œè®Šæ•¸
const showBusinessHours = ref(false);
const isEditingHours = ref(false);
const businessHours = ref({});
const specialHours = ref([]);
const originalBusinessHours = ref({});
const originalSpecialHours = ref([]);

// æ˜ŸæœŸå°ç…§
const weekDays = [
  {name: 'é€±æ—¥', value: 0},
  {name: 'é€±ä¸€', value: 1},
  {name: 'é€±äºŒ', value: 2},
  {name: 'é€±ä¸‰', value: 3},
  {name: 'é€±å››', value: 4},
  {name: 'é€±äº”', value: 5},
  {name: 'é€±å…­', value: 6},
];

const orderLink = computed(() => {
  if (merchantInfo.value.lineId) {
    return `${window.location.origin}/menu/${merchantInfo.value.lineId}/login`;
  }
  return 'è¨­å®šå®Œæˆå¾Œé¡¯ç¤º';
});

// æª¢æŸ¥æ˜¯å¦æœ‰ LINE Pay è¨­å®š
const hasLinePaySettings = computed(() => {
  return (
    merchantInfo.value.linePay_channel_id &&
    merchantInfo.value.linePay_secret_key
  );
});

// è¼‰å…¥å•†å®¶è³‡è¨Š
const loadMerchantInfo = async () => {
  try {
    const {data} = await $fetch('/api/merchant/info');
    console.log('Loaded merchant data:', data); // èª¿è©¦ä¿¡æ¯
    merchantInfo.value = data;
    isBusinessOpen.value = data.is_active === 1;
    isOrderServiceOpen.value = data.order_service_active === 1;

    console.log('Status values:', {
      // èª¿è©¦ä¿¡æ¯
      is_active: data.is_active,
      order_service_active: data.order_service_active,
      isBusinessOpen: isBusinessOpen.value,
      isOrderServiceOpen: isOrderServiceOpen.value,
    });

    // è¼‰å…¥å•†å®¶è¨­å®š
    merchantSettings.value = {
      available_dining_types: data.available_dining_types || ['takeaway'],
      available_payment_methods: data.available_payment_methods || ['cash'],
      advance_discount_rate: data.advance_discount_rate || 0,
      delivery_minimum_amount: data.delivery_minimum_amount || 0,
      delivery_base_fee: data.delivery_base_fee || 0,
      delivery_free_km: data.delivery_free_km || 0,
      delivery_per_km_fee: data.delivery_per_km_fee || 0,
      delivery_prepayment: data.delivery_prepayment || 0,
      max_delivery_distance: data.max_delivery_distance || 0,
    };
  } catch (error) {
    console.error('Failed to load merchant info:', error);
  }
};

// è¼‰å…¥è¨‚å–®çµ±è¨ˆè³‡æ–™
const loadOrderStats = async () => {
  try {
    const {data} = await $fetch('/api/merchant/order-statistics');
    orderStats.value = data;

    // è§¸ç™¼å‹•ç•«è¨ˆæ•¸å™¨
    startCountAnimation();
  } catch (error) {
    console.error('Failed to load order statistics:', error);
  }
};

// å‹•ç•«è¨ˆæ•¸å™¨
const startCountAnimation = () => {
  const targetOrders = orderStats.value.totalOrders;
  const targetRevenue = orderStats.value.totalRevenue;

  // é‡ç½®è¨ˆæ•¸å™¨
  animatedOrderCount.value = 0;
  animatedRevenue.value = 0;

  // è¨ˆç®—å‹•ç•«æŒçºŒæ™‚é–“å’Œæ­¥é©Ÿ
  const duration = 2000; // 2ç§’
  const steps = 60; // 60æ­¥
  const interval = duration / steps;

  const orderStep = targetOrders / steps;
  const revenueStep = targetRevenue / steps;

  let currentStep = 0;

  const timer = setInterval(() => {
    currentStep++;

    if (currentStep <= steps) {
      animatedOrderCount.value = Math.min(
        Math.floor(orderStep * currentStep),
        targetOrders
      );
      animatedRevenue.value = Math.min(
        Math.floor(revenueStep * currentStep),
        targetRevenue
      );
    }

    if (currentStep >= steps) {
      // ç¢ºä¿æœ€çµ‚å€¼æº–ç¢º
      animatedOrderCount.value = targetOrders;
      animatedRevenue.value = targetRevenue;
      clearInterval(timer);
    }
  }, interval);
};

// å‰å¾€ LINE ä½¿ç”¨é‡èªªæ˜é é¢
const goToLineUsage = () => {
  navigateTo('/admin/line-usage');
};

// æ›´æ–°å•†å®¶è¨­å®š
const updateSettings = async () => {
  try {
    await $fetch('/api/merchant/setup', {
      method: 'POST',
      body: {
        ...merchantInfo.value,
        available_dining_types: merchantSettings.value.available_dining_types,
        available_payment_methods:
          merchantSettings.value.available_payment_methods,
        advance_discount_rate: merchantSettings.value.advance_discount_rate,
        delivery_minimum_amount: merchantSettings.value.delivery_minimum_amount,
        delivery_base_fee: merchantSettings.value.delivery_base_fee,
        delivery_free_km: merchantSettings.value.delivery_free_km,
        delivery_per_km_fee: merchantSettings.value.delivery_per_km_fee,
        delivery_prepayment: merchantSettings.value.delivery_prepayment,
        max_delivery_distance: merchantSettings.value.max_delivery_distance,
      },
    });
  } catch (error) {
    console.error('Failed to update merchant settings:', error);
    alert('è¨­å®šæ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// é–‹å§‹ç·¨è¼¯
const startEditing = () => {
  // ä¿å­˜åŸå§‹è¨­å®šå€¼
  originalSettings.value = {
    available_dining_types: [...merchantSettings.value.available_dining_types],
    available_payment_methods: [
      ...merchantSettings.value.available_payment_methods,
    ],
    advance_discount_rate: merchantSettings.value.advance_discount_rate,
    delivery_minimum_amount: merchantSettings.value.delivery_minimum_amount,
    delivery_base_fee: merchantSettings.value.delivery_base_fee,
    delivery_free_km: merchantSettings.value.delivery_free_km,
    delivery_per_km_fee: merchantSettings.value.delivery_per_km_fee,
    delivery_prepayment: merchantSettings.value.delivery_prepayment,
    max_delivery_distance: merchantSettings.value.max_delivery_distance,
  };
  isEditing.value = true;
};

// å–æ¶ˆç·¨è¼¯
const cancelEditing = () => {
  // é‚„åŸåŸå§‹è¨­å®šå€¼
  merchantSettings.value = {
    available_dining_types: [...originalSettings.value.available_dining_types],
    available_payment_methods: [
      ...originalSettings.value.available_payment_methods,
    ],
    advance_discount_rate: originalSettings.value.advance_discount_rate,
    delivery_minimum_amount: originalSettings.value.delivery_minimum_amount,
    delivery_base_fee: originalSettings.value.delivery_base_fee,
    delivery_free_km: originalSettings.value.delivery_free_km,
    delivery_per_km_fee: originalSettings.value.delivery_per_km_fee,
    delivery_prepayment: originalSettings.value.delivery_prepayment,
    max_delivery_distance: originalSettings.value.max_delivery_distance,
  };
  isEditing.value = false;
};

// ä¿å­˜æ‰€æœ‰è¨­å®š
const saveAllSettings = async () => {
  try {
    // æª¢æŸ¥éŠ€è¡Œè½‰å¸³è¨­å®š
    if (
      merchantSettings.value.available_payment_methods.includes('bank_transfer')
    ) {
      if (
        !merchantInfo.value.bank_account ||
        merchantInfo.value.bank_account.trim() === ''
      ) {
        alert('è«‹å…ˆåœ¨ã€Œé€²éšè¨­å®šã€ä¸­è¨­å®šæ”¶æ¬¾å¸³è™Ÿï¼Œæ‰èƒ½æä¾›éŠ€è¡Œè½‰å¸³ä»˜æ¬¾æ–¹å¼');
        return;
      }
    }

    await updateSettings();
    isEditing.value = false;
  } catch (error) {
    console.error('ä¿å­˜è¨­å®šå¤±æ•—:', error);
    alert('ä¿å­˜è¨­å®šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// åˆ‡æ›å¤–é€æœå‹™
const toggleDeliveryService = (event) => {
  const isChecked = event.target.checked;
  if (isChecked) {
    // é–‹å•Ÿå¤–é€æœå‹™
    if (!merchantSettings.value.available_dining_types.includes('delivery')) {
      merchantSettings.value.available_dining_types.push('delivery');
    }
  } else {
    // é—œé–‰å¤–é€æœå‹™
    merchantSettings.value.available_dining_types =
      merchantSettings.value.available_dining_types.filter(
        (type) => type !== 'delivery'
      );
  }
};

// å–å¾—ç”¨é¤æ–¹å¼é¡¯ç¤ºæ–‡å­—
const getDiningTypesDisplay = () => {
  const types = merchantSettings.value.available_dining_types || [];
  const typeMap = {
    takeaway: 'å¤–å¸¶',
    'dine-in': 'å…§ç”¨',
    delivery: 'å¤–é€',
  };

  if (types.length === 0) return 'æœªè¨­å®š';
  return types.map((type) => typeMap[type] || type).join('ã€');
};

// å–å¾—æ”¯ä»˜æ–¹å¼é¡¯ç¤ºæ–‡å­—
const getPaymentMethodsDisplay = () => {
  const methods = merchantSettings.value.available_payment_methods || [];
  const methodMap = {
    cash: 'ç¾å ´ä»˜æ¬¾',
    bank_transfer: 'éŠ€è¡Œè½‰å¸³',
    mobile: 'è¡Œå‹•æ”¯ä»˜',
  };

  if (methods.length === 0) return 'æœªè¨­å®š';
  return methods.map((method) => methodMap[method] || method).join('ã€');
};

// æª¢æŸ¥éŠ€è¡Œè½‰å¸³æ˜¯å¦å¯ç”¨
const isBankTransferAvailable = computed(() => {
  return (
    merchantInfo.value.bank_account &&
    merchantInfo.value.bank_account.trim() !== ''
  );
});

// æª¢æŸ¥æ˜¯å¦é¸æ“‡äº†éŠ€è¡Œè½‰å¸³ä½†æ²’æœ‰è¨­å®šå¸³è™Ÿ
const hasBankTransferWithoutAccount = computed(() => {
  return (
    merchantSettings.value.available_payment_methods.includes(
      'bank_transfer'
    ) && !isBankTransferAvailable.value
  );
});

// ç™»å‡ºåŠŸèƒ½
const logout = async () => {
  try {
    await $fetch('/api/auth/logout', {method: 'POST'});
    await navigateTo('/admin/login');
  } catch (error) {
    console.error('Logout failed:', error);
    // å¼·åˆ¶é‡å®šå‘
    await navigateTo('/');
  }
};

// å‰å¾€è¨­å®šé é¢
const goToSettings = () => {
  navigateTo('/admin/settings');
};

// å‰å¾€å•†å“ç®¡ç†
const goToProducts = () => {
  navigateTo('/admin/products');
};

// è¤‡è£½é»é¤é€£çµ
const copyOrderLink = async () => {
  try {
    await navigator.clipboard.writeText(orderLink.value);
    alert('é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿');
  } catch (error) {
    console.error('Copy failed:', error);
    alert('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½');
  }
};

// å‰å¾€åº—å®¶è³‡è¨Šé é¢
const goToStoreInfo = () => {
  navigateTo('/admin/store-info');
};

// å–å¾—åº—å®¶åç¨±é¦–å­—æ¯
const getStoreInitial = (storeName) => {
  if (!storeName) return 'åº—';
  return storeName.charAt(0).toUpperCase();
};

// åˆ‡æ›ç‡Ÿæ¥­ç‹€æ…‹
const toggleBusinessStatus = async () => {
  try {
    const newIsActive = isBusinessOpen.value ? 1 : 0;

    // ä½¿ç”¨å°ˆé–€çš„ç‹€æ…‹æ›´æ–° APIï¼Œä¸¦è¨­ç½®æ‰‹å‹•æ§åˆ¶æ¨™è¨˜
    await $fetch('/api/merchant/update-active-status', {
      method: 'POST',
      body: {
        is_active: newIsActive,
        manual_override: true, // è¨­ç½®ç‚ºæ‰‹å‹•æ§åˆ¶
      },
    });

    // æ›´æ–°æœ¬åœ°ç‹€æ…‹
    merchantInfo.value.is_active = newIsActive;
    merchantInfo.value.manual_override_until_midnight = 1;

    // å¦‚æœé—œé–‰ç‡Ÿæ¥­ï¼Œè‡ªå‹•æ‰“é–‹è¨‚é¤æœå‹™
    if (newIsActive === 0) {
      const orderServiceBody = {
        ...merchantInfo.value,
        order_service_active: 1,
      };

      await $fetch('/api/merchant/setup', {
        method: 'POST',
        body: orderServiceBody,
      });

      merchantInfo.value.order_service_active = 1;
      isOrderServiceOpen.value = true;
    }

    console.log(
      'Business status manually updated to:',
      newIsActive ? 'open' : 'closed'
    );
  } catch (error) {
    console.error('Failed to update business status:', error);
    // å¦‚æœæ›´æ–°å¤±æ•—ï¼Œé‚„åŸç‹€æ…‹
    isBusinessOpen.value = !isBusinessOpen.value;
    if (newIsActive === 0) {
      isOrderServiceOpen.value = false;
    }
    alert('ç‡Ÿæ¥­ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// åˆ‡æ›è¨‚é¤æœå‹™ç‹€æ…‹
const toggleOrderService = async () => {
  try {
    const newOrderServiceActive = isOrderServiceOpen.value ? 1 : 0;
    console.log('Toggling order service to:', newOrderServiceActive); // èª¿è©¦ä¿¡æ¯

    await $fetch('/api/merchant/setup', {
      method: 'POST',
      body: {
        ...merchantInfo.value,
        order_service_active: newOrderServiceActive,
      },
    });

    merchantInfo.value.order_service_active = newOrderServiceActive;
    console.log('Order service updated successfully'); // èª¿è©¦ä¿¡æ¯
  } catch (error) {
    console.error('Failed to update order service status:', error);
    // å¦‚æœæ›´æ–°å¤±æ•—ï¼Œé‚„åŸç‹€æ…‹
    isOrderServiceOpen.value = !isOrderServiceOpen.value;
    alert('è¨‚é¤æœå‹™ç‹€æ…‹æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

useHead({
  title: computed(() =>
    merchantInfo.value.store_name
      ? `thankQå„€è¡¨æ¿ - ${merchantInfo.value.store_name}`
      : 'thankQå„€è¡¨æ¿'
  ),
  meta: [
    {
      name: 'description',
      content: computed(
        () => merchantInfo.value.store_description || 'thankQå„€è¡¨æ¿'
      ),
    },
  ],
});

// ç‡Ÿæ¥­æ™‚é–“ç›¸é—œå‡½æ•¸
const loadBusinessHours = async () => {
  try {
    const {data} = await $fetch('/api/merchant/business-hours');
    console.log('Loaded business hours data:', data);

    // åˆå§‹åŒ–ç‡Ÿæ¥­æ™‚é–“ç‰©ä»¶
    const hours = {};
    for (let i = 0; i <= 6; i++) {
      const found = data.businessHours.find((h) => h.day_of_week === i);
      hours[i] = found
        ? {
            is_open: found.is_open,
            open_time: found.open_time ? found.open_time.slice(0, 5) : '09:00',
            close_time: found.close_time
              ? found.close_time.slice(0, 5)
              : '18:00',
            break_start_time: found.break_start_time
              ? found.break_start_time.slice(0, 5)
              : null,
            break_end_time: found.break_end_time
              ? found.break_end_time.slice(0, 5)
              : null,
          }
        : {
            is_open: false,
            open_time: '09:00',
            close_time: '18:00',
            break_start_time: null,
            break_end_time: null,
          };
    }

    businessHours.value = hours;

    // æŒ‰æ—¥æœŸæ’åºä¼‘å‡æ—¥æœŸï¼ˆæœ€æ—©çš„åœ¨ä¸Šé¢ï¼‰
    const sortedSpecialHours = (data.specialHours || []).sort((a, b) => {
      return new Date(a.date) - new Date(b.date);
    });

    console.log('Setting special hours:', sortedSpecialHours);
    specialHours.value = sortedSpecialHours;
  } catch (error) {
    console.error('Failed to load business hours:', error);
  }
};

const startEditingHours = async () => {
  // é‡æ–°è¼‰å…¥æœ€æ–°æ•¸æ“šä»¥ç¢ºä¿åŒæ­¥
  await loadBusinessHours();

  // ä¿å­˜åŸå§‹æ•¸æ“š
  originalBusinessHours.value = JSON.parse(JSON.stringify(businessHours.value));
  originalSpecialHours.value = JSON.parse(JSON.stringify(specialHours.value));
  isEditingHours.value = true;
};

const cancelEditingHours = () => {
  // é‚„åŸåŸå§‹æ•¸æ“š
  businessHours.value = JSON.parse(JSON.stringify(originalBusinessHours.value));
  specialHours.value = JSON.parse(JSON.stringify(originalSpecialHours.value));
  isEditingHours.value = false;
};

const saveBusinessHours = async () => {
  try {
    // é©—è­‰ä¼‘å‡æ—¥æœŸ
    for (const special of specialHours.value) {
      if (!special.id) {
        // åªé©—è­‰æ–°å¢çš„é …ç›®
        if (!special.date) {
          alert('âŒ è«‹é¸æ“‡ä¼‘å‡æ—¥æœŸ');
          return;
        }
        if (!special.reason || special.reason.trim() === '') {
          alert('âŒ è«‹å¡«å¯«ä¼‘å‡åŸå› ');
          return;
        }
        // é©—è­‰æ—¥æœŸå¿…é ˆæ˜¯ä»Šå¤©ä»¥å¾Œï¼ˆåŒ…å«ä»Šå¤©ï¼‰
        const selectedDate = new Date(special.date);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        selectedDate.setHours(0, 0, 0, 0);

        if (selectedDate < today) {
          alert('âŒ ä¼‘å‡æ—¥æœŸä¸èƒ½æ˜¯éå»çš„æ—¥æœŸ');
          return;
        }

        // æª¢æŸ¥æ—¥æœŸæ˜¯å¦é‡è¤‡
        const existingDates = specialHours.value
          .filter(
            (s, i) =>
              i !== specialHours.value.findIndex((item) => item === special)
          ) // æ’é™¤è‡ªå·±
          .map((s) => s.date);

        if (existingDates.includes(special.date)) {
          alert('âŒ ä¼‘å‡æ—¥æœŸä¸èƒ½é‡è¤‡');
          return;
        }
      }
    }

    // è½‰æ›æ ¼å¼ä»¥ç¬¦åˆAPIéœ€æ±‚
    const businessHoursArray = Object.keys(businessHours.value).map(
      (dayOfWeek) => ({
        day_of_week: parseInt(dayOfWeek),
        is_open: businessHours.value[dayOfWeek].is_open,
        open_time: businessHours.value[dayOfWeek].is_open
          ? formatTimeForDb(businessHours.value[dayOfWeek].open_time)
          : null,
        close_time: businessHours.value[dayOfWeek].is_open
          ? formatTimeForDb(businessHours.value[dayOfWeek].close_time)
          : null,
        break_start_time: businessHours.value[dayOfWeek].break_start_time
          ? formatTimeForDb(businessHours.value[dayOfWeek].break_start_time)
          : null,
        break_end_time: businessHours.value[dayOfWeek].break_end_time
          ? formatTimeForDb(businessHours.value[dayOfWeek].break_end_time)
          : null,
      })
    );

    const specialHoursArray = specialHours.value.map((special) => ({
      id: special.id,
      date: special.date,
      is_open: false, // ä¼‘å‡æ—¥æœŸå›ºå®šç‚ºé—œé–‰
      open_time: null,
      close_time: null,
      reason: special.reason,
    }));

    await $fetch('/api/merchant/business-hours', {
      method: 'POST',
      body: {
        businessHours: businessHoursArray,
        specialHours: specialHoursArray,
      },
    });

    // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿æ’åºæ­£ç¢º
    await loadBusinessHours();

    isEditingHours.value = false;
    alert('ç‡Ÿæ¥­æ™‚é–“è¨­å®šå·²ä¿å­˜');
  } catch (error) {
    console.error('Failed to save business hours:', error);
    alert('ä¿å­˜å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

const addSpecialHour = () => {
  const today = new Date();

  specialHours.value.push({
    date: today.toISOString().substring(0, 10),
    is_open: false,
    open_time: null,
    close_time: null,
    reason: '',
  });
};

const removeSpecialHour = (index) => {
  specialHours.value.splice(index, 1);
};

// åˆªé™¤å·²ä¿å­˜çš„ä¼‘å‡æ—¥æœŸ
const deleteSpecialHour = async (specialId, index) => {
  if (!specialId) {
    // å¦‚æœæ²’æœ‰ IDï¼Œç›´æ¥å¾é™£åˆ—ä¸­ç§»é™¤ï¼ˆæœªä¿å­˜çš„é …ç›®ï¼‰
    specialHours.value.splice(index, 1);
    return;
  }

  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å€‹ä¼‘å‡æ—¥æœŸå—ï¼Ÿ')) {
    return;
  }

  try {
    await $fetch(`/api/merchant/special-hours/${specialId}`, {
      method: 'DELETE',
    });

    // é‡æ–°è¼‰å…¥è³‡æ–™ä»¥ç¢ºä¿èˆ‡è³‡æ–™åº«åŒæ­¥
    await loadBusinessHours();

    alert('ğŸ—‘ï¸ ä¼‘å‡æ—¥æœŸå·²åˆªé™¤');
  } catch (error) {
    console.error('Failed to delete special hour:', error);
    alert('âŒ åˆªé™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
  }
};

// ç²å–ä»Šå¤©æ—¥æœŸï¼ˆç”¨æ–¼æ—¥æœŸè¼¸å…¥çš„æœ€å°å€¼ï¼‰
const getTodayDate = () => {
  const today = new Date();
  return today.toISOString().substring(0, 10);
};

const getBusinessHourDisplay = (dayOfWeek) => {
  const hour = businessHours.value[dayOfWeek];
  if (!hour || !hour.is_open) {
    return 'ä¼‘æ¯';
  }
  if (!hour.open_time || !hour.close_time) {
    return 'å…¨å¤©ç‡Ÿæ¥­';
  }
  return `${hour.open_time} - ${hour.close_time}`;
};

const getSpecialHourDisplay = (special) => {
  return 'ä¼‘å‡';
};

const formatSpecialDate = (dateString) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    weekday: 'short',
  });
};

// å³æ™‚æ›´æ–°å•†å®¶ç‡Ÿæ¥­ç‹€æ…‹
const updateMerchantActiveStatus = async () => {
  try {
    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°çš„ä¸€å¤©ï¼Œå¦‚æœæ˜¯å‰‡é‡ç½®æ‰‹å‹•æ§åˆ¶æ¨™è¨˜
    await resetManualOverrideIfNeeded();

    // å¦‚æœå•†å®¶è¨­å®šäº†æ‰‹å‹•æ§åˆ¶ï¼Œå‰‡ä¸é€²è¡Œè‡ªå‹•ç‹€æ…‹æ›´æ–°
    if (merchantInfo.value.manual_override_until_midnight === 1) {
      console.log('Manual override is active, skipping auto status update');
      return;
    }

    const now = new Date();
    const currentDay = now.getDay();
    const currentHour = now.getHours();
    const currentMinute = now.getMinutes();
    const currentTimeInMinutes = currentHour * 60 + currentMinute;

    // æª¢æŸ¥ä»Šæ—¥æ˜¯å¦ç‚ºä¼‘å‡æ—¥
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const isHoliday = specialHours.value.some((special) => {
      const specialDate = new Date(special.date);
      specialDate.setHours(0, 0, 0, 0);
      return specialDate.getTime() === today.getTime() && !special.is_open;
    });

    // å¦‚æœæ˜¯ä¼‘å‡æ—¥ï¼Œè¨­ç‚ºé—œé–‰
    if (isHoliday) {
      if (merchantInfo.value.is_active !== 0) {
        await $fetch('/api/merchant/update-active-status', {
          method: 'POST',
          body: {is_active: 0},
        });
        merchantInfo.value.is_active = 0;
      }
      return;
    }

    // æª¢æŸ¥ç•¶å‰æ™‚é–“æ˜¯å¦åœ¨ç‡Ÿæ¥­æ™‚é–“å…§
    const businessHour = businessHours.value[currentDay];
    let shouldBeActive = false;

    if (
      businessHour &&
      businessHour.is_open &&
      businessHour.open_time &&
      businessHour.close_time
    ) {
      // è§£æç‡Ÿæ¥­æ™‚é–“
      const parseTime = (timeStr) => {
        const parts = timeStr.split(':');
        return parseInt(parts[0]) * 60 + parseInt(parts[1]);
      };

      const openTimeInMinutes = parseTime(businessHour.open_time);
      const closeTimeInMinutes = parseTime(businessHour.close_time);

      // æª¢æŸ¥æ˜¯å¦è·¨å¤œç‡Ÿæ¥­
      if (closeTimeInMinutes <= openTimeInMinutes) {
        // è·¨å¤œç‡Ÿæ¥­
        if (closeTimeInMinutes === 0) {
          // ç‡Ÿæ¥­åˆ°åˆå¤œ
          shouldBeActive = currentTimeInMinutes >= openTimeInMinutes;
        } else {
          // è·¨å¤œä½†ä¸åˆ°åˆå¤œ
          shouldBeActive =
            currentTimeInMinutes >= openTimeInMinutes ||
            currentTimeInMinutes <= closeTimeInMinutes;
        }
      } else {
        // ä¸€èˆ¬ç‡Ÿæ¥­æ™‚é–“
        shouldBeActive =
          currentTimeInMinutes >= openTimeInMinutes &&
          currentTimeInMinutes <= closeTimeInMinutes;
      }
    }

    // æ›´æ–°ç‹€æ…‹ï¼ˆå¦‚æœæœ‰è®ŠåŒ–ï¼‰
    const newActiveStatus = shouldBeActive ? 1 : 0;
    if (merchantInfo.value.is_active !== newActiveStatus) {
      await $fetch('/api/merchant/update-active-status', {
        method: 'POST',
        body: {is_active: newActiveStatus},
      });
      merchantInfo.value.is_active = newActiveStatus;
      isBusinessOpen.value = newActiveStatus === 1;
    }
  } catch (error) {
    console.error('Failed to update merchant active status:', error);
  }
};

// æª¢æŸ¥æ˜¯å¦éœ€è¦é‡ç½®æ‰‹å‹•æ§åˆ¶æ¨™è¨˜ï¼ˆæ–°çš„ä¸€å¤©ï¼‰
const resetManualOverrideIfNeeded = async () => {
  try {
    const response = await $fetch('/api/merchant/reset-manual-override', {
      method: 'POST',
    });

    // ç„¡è«–æ˜¯å¦é‡ç½®ï¼Œéƒ½è¦é‡æ–°è¼‰å…¥å•†å®¶è³‡è¨Šä»¥ç²å–æœ€æ–°çš„ manual_override ç‹€æ…‹
    const {data} = await $fetch('/api/merchant/info');
    merchantInfo.value.manual_override_until_midnight =
      data.manual_override_until_midnight;

    if (response.reset) {
      console.log('Manual override was reset for new day');
    }
  } catch (error) {
    console.error('Failed to reset manual override:', error);
  }
};

// é é¢è¼‰å…¥æ™‚å–å¾—å•†å®¶è³‡è¨Š
onMounted(async () => {
  await loadMerchantInfo();
  await loadBusinessHours();
  await loadOrderStats(); // è¼‰å…¥è¨‚å–®çµ±è¨ˆ
  // è¼‰å…¥å®Œæˆå¾Œæª¢æŸ¥ä¸¦æ›´æ–°ç‡Ÿæ¥­ç‹€æ…‹
  await updateMerchantActiveStatus();
});
</script>
